metadata:
  name: pth-ultralytics-yolov8pose_weeds
  namespace: cvat
  annotations:
    name: Weeds pose estimation
    type: detector
    spec: |
      [
        {
          "name": "weed",
          "type": "skeleton",
          "svg": "<line x1=\"54.25419998168945\" y1=\"7.804621696472168\" x2=\"51.2289924621582\" y2=\"7.636554718017578\" data-type=\"edge\" data-node-from=\"4\" data-node-to=\"2\"></line>\n<line x1=\"47.195377349853516\" y1=\"7.636554718017578\" x2=\"44.170169830322266\" y2=\"7.804621696472168\" data-type=\"edge\" data-node-from=\"3\" data-node-to=\"5\"></line>\n<line x1=\"48.87604904174805\" y1=\"9.485294342041016\" x2=\"47.195377349853516\" y2=\"7.636554718017578\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"3\"></line>\n<line x1=\"48.87604904174805\" y1=\"9.485294342041016\" x2=\"51.2289924621582\" y2=\"7.636554718017578\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"2\"></line>\n<line x1=\"60.80882263183594\" y1=\"19.90546226501465\" x2=\"48.87604904174805\" y2=\"9.485294342041016\" data-type=\"edge\" data-node-from=\"6\" data-node-to=\"1\"></line>\n<line x1=\"63.83403396606445\" y1=\"34.023109436035156\" x2=\"60.80882263183594\" y2=\"19.90546226501465\" data-type=\"edge\" data-node-from=\"8\" data-node-to=\"6\"></line>\n<line x1=\"66.85924530029297\" y1=\"47.132354736328125\" x2=\"63.83403396606445\" y2=\"34.023109436035156\" data-type=\"edge\" data-node-from=\"10\" data-node-to=\"8\"></line>\n<line x1=\"58.119747161865234\" y1=\"71.16596984863281\" x2=\"57.78361511230469\" y2=\"87.97268676757812\" data-type=\"edge\" data-node-from=\"14\" data-node-to=\"16\"></line>\n<line x1=\"57.11134338378906\" y1=\"49.65336227416992\" x2=\"58.119747161865234\" y2=\"71.16596984863281\" data-type=\"edge\" data-node-from=\"12\" data-node-to=\"14\"></line>\n<line x1=\"48.87604904174805\" y1=\"9.485294342041016\" x2=\"57.11134338378906\" y2=\"49.65336227416992\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"12\"></line>\n<line x1=\"44.00210189819336\" y1=\"50.157562255859375\" x2=\"48.87604904174805\" y2=\"9.485294342041016\" data-type=\"edge\" data-node-from=\"13\" data-node-to=\"1\"></line>\n<line x1=\"44.338233947753906\" y1=\"70.6617660522461\" x2=\"44.00210189819336\" y2=\"50.157562255859375\" data-type=\"edge\" data-node-from=\"15\" data-node-to=\"13\"></line>\n<line x1=\"46.186973571777344\" y1=\"92.51050567626953\" x2=\"44.338233947753906\" y2=\"70.6617660522461\" data-type=\"edge\" data-node-from=\"17\" data-node-to=\"15\"></line>\n<line x1=\"35.93487548828125\" y1=\"34.35924530029297\" x2=\"33.918067932128906\" y2=\"47.46848678588867\" data-type=\"edge\" data-node-from=\"9\" data-node-to=\"11\"></line>\n<line x1=\"37.78361511230469\" y1=\"20.409664154052734\" x2=\"35.93487548828125\" y2=\"34.35924530029297\" data-type=\"edge\" data-node-from=\"7\" data-node-to=\"9\"></line>\n<line x1=\"48.87604904174805\" y1=\"9.485294342041016\" x2=\"37.78361511230469\" y2=\"20.409664154052734\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"7\"></line>\n<circle r=\"0.75\" cx=\"48.87604904174805\" cy=\"9.485294342041016\" data-type=\"element node\" data-element-id=\"1\" data-node-id=\"1\" data-label-name=\"1\"></circle>\n<circle r=\"0.75\" cx=\"51.2289924621582\" cy=\"7.636554718017578\" data-type=\"element node\" data-element-id=\"2\" data-node-id=\"2\" data-label-name=\"2\"></circle>\n<circle r=\"0.75\" cx=\"47.195377349853516\" cy=\"7.636554718017578\" data-type=\"element node\" data-element-id=\"3\" data-node-id=\"3\" data-label-name=\"3\"></circle>\n<circle r=\"0.75\" cx=\"54.25419998168945\" cy=\"7.804621696472168\" data-type=\"element node\" data-element-id=\"4\" data-node-id=\"4\" data-label-name=\"4\"></circle>\n<circle r=\"0.75\" cx=\"44.170169830322266\" cy=\"7.804621696472168\" data-type=\"element node\" data-element-id=\"5\" data-node-id=\"5\" data-label-name=\"5\"></circle>\n<circle r=\"0.75\" cx=\"60.80882263183594\" cy=\"19.90546226501465\" data-type=\"element node\" data-element-id=\"6\" data-node-id=\"6\" data-label-name=\"6\"></circle>\n<circle r=\"0.75\" cx=\"37.78361511230469\" cy=\"20.409664154052734\" data-type=\"element node\" data-element-id=\"7\" data-node-id=\"7\" data-label-name=\"7\"></circle>\n<circle r=\"0.75\" cx=\"63.83403396606445\" cy=\"34.023109436035156\" data-type=\"element node\" data-element-id=\"8\" data-node-id=\"8\" data-label-name=\"8\"></circle>\n<circle r=\"0.75\" cx=\"35.93487548828125\" cy=\"34.35924530029297\" data-type=\"element node\" data-element-id=\"9\" data-node-id=\"9\" data-label-name=\"9\"></circle>\n<circle r=\"0.75\" cx=\"66.85924530029297\" cy=\"47.132354736328125\" data-type=\"element node\" data-element-id=\"10\" data-node-id=\"10\" data-label-name=\"10\"></circle>\n<circle r=\"0.75\" cx=\"33.918067932128906\" cy=\"47.46848678588867\" data-type=\"element node\" data-element-id=\"11\" data-node-id=\"11\" data-label-name=\"11\"></circle>\n<circle r=\"0.75\" cx=\"57.11134338378906\" cy=\"49.65336227416992\" data-type=\"element node\" data-element-id=\"12\" data-node-id=\"12\" data-label-name=\"12\"></circle>\n<circle r=\"0.75\" cx=\"44.00210189819336\" cy=\"50.157562255859375\" data-type=\"element node\" data-element-id=\"13\" data-node-id=\"13\" data-label-name=\"13\"></circle>\n<circle r=\"0.75\" cx=\"58.119747161865234\" cy=\"71.16596984863281\" data-type=\"element node\" data-element-id=\"14\" data-node-id=\"14\" data-label-name=\"14\"></circle>\n<circle r=\"0.75\" cx=\"44.338233947753906\" cy=\"70.6617660522461\" data-type=\"element node\" data-element-id=\"15\" data-node-id=\"15\" data-label-name=\"15\"></circle>\n<circle r=\"0.75\" cx=\"57.78361511230469\" cy=\"87.97268676757812\" data-type=\"element node\" data-element-id=\"16\" data-node-id=\"16\" data-label-name=\"16\"></circle>\n<circle r=\"0.75\" cx=\"46.186973571777344\" cy=\"92.51050567626953\" data-type=\"element node\" data-element-id=\"17\" data-node-id=\"17\" data-label-name=\"17\"></circle>",
          "sublabels": [
              { "id": 0, "name": "center", "type": "points" },
              { "id": 1, "name": "top_left", "type": "points" },
              { "id": 2, "name": "top_right", "type": "points" },
              { "id": 3, "name": "bottom_left", "type": "points" },
              { "id": 4, "name": "bottom_right", "type": "points" }
          ]
        }
      ]

spec:
  description: Weed laser point estimation
  runtime: 'python:3.10'
  handler: main:handler
  eventTimeout: 30s

  build:
    image: cvat.pth.ultralytics.yolov8pose_weeds
    baseImage: python:3.10

    directives:
      preCopy:
        - kind: RUN
          value: apt update && apt install -y git libgl1 --no-install-recommends && rm -rf /var/lib/apt/lists/*
        - kind: WORKDIR
          value: /opt/nuclio
        - kind: RUN
          value: pip uninstall numpy && pip install "numpy<1.26.0"
        - kind: RUN
          value: pip install torch==2.0.0+cpu torchvision==0.15.1+cpu --extra-index-url https://download.pytorch.org/whl/cpu
        - kind: RUN
          value: pip install ultralytics opencv-python-headless==4.8.0.74 opencv-contrib-python==4.8.0.74 opencv-contrib-python-headless==4.8.0.74 pillow
        - kind: RUN
          value: pip install debugpy
  triggers:
    myHttpTrigger:
      maxWorkers: 2
      kind: 'http'
      workerAvailabilityTimeoutMilliseconds: 10000
      attributes:
        maxRequestBodySize: 33554432 # 32MB

  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
      mountMode: volume
