metadata:
  name: pth-ultralytics-yolov8pose_weeds
  namespace: cvat
  annotations:
    name: Weeds pose estimation
    type: detector
    spec: |
      [
        {
          "name": "weed",
          "type": "skeleton",
          "svg": "<line x1=\"48.91304397583008\" y1=\"46.989967346191406\" x2=\"0.9197324514389038\" y2=\"99.49832916259766\" stroke=\"black\" data-type=\"edge\" data-node-from=\"1\" stroke-width=\"0.5\" data-node-to=\"4\"/>\n<line x1=\"48.91304397583008\" y1=\"46.989967346191406\" x2=\"98.91304016113281\" y2=\"0.8361204266548157\" stroke=\"black\" data-type=\"edge\" data-node-from=\"1\" stroke-width=\"0.5\" data-node-to=\"2\"/>\n<line x1=\"0.5852842926979065\" y1=\"0.8361204266548157\" x2=\"48.91304397583008\" y2=\"46.989967346191406\" stroke=\"black\" data-type=\"edge\" data-node-from=\"3\" stroke-width=\"0.5\" data-node-to=\"1\"/>\n<line x1=\"0.9197324514389038\" y1=\"99.49832916259766\" x2=\"0.5852842926979065\" y2=\"0.8361204266548157\" stroke=\"black\" data-type=\"edge\" data-node-from=\"4\" stroke-width=\"0.5\" data-node-to=\"3\"/>\n<line x1=\"0.9197324514389038\" y1=\"99.49832916259766\" x2=\"99.74916076660156\" y2=\"98.82942962646484\" stroke=\"black\" data-type=\"edge\" data-node-from=\"4\" stroke-width=\"0.5\" data-node-to=\"5\"/>\n<line x1=\"98.91304016113281\" y1=\"0.8361204266548157\" x2=\"99.74916076660156\" y2=\"98.82942962646484\" stroke=\"black\" data-type=\"edge\" data-node-from=\"2\" stroke-width=\"0.5\" data-node-to=\"5\"/>\n<line x1=\"0.5852842926979065\" y1=\"0.8361204266548157\" x2=\"98.91304016113281\" y2=\"0.8361204266548157\" stroke=\"black\" data-type=\"edge\" data-node-from=\"3\" stroke-width=\"0.5\" data-node-to=\"2\"/>\n<circle r=\"0.75\" cx=\"48.91304397583008\" cy=\"46.989967346191406\" data-type=\"element node\" data-element-id=\"1\" data-node-id=\"1\" stroke=\"black\" fill=\"#ff355e\" stroke-width=\"0.1\"/>\n<circle r=\"0.75\" cx=\"98.91304016113281\" cy=\"0.8361204266548157\" data-type=\"element node\" data-element-id=\"2\" data-node-id=\"2\" stroke=\"black\" fill=\"#3d3df5\" stroke-width=\"0.1\"/>\n<circle r=\"0.75\" cx=\"0.5852842926979065\" cy=\"0.8361204266548157\" data-type=\"element node\" data-element-id=\"3\" data-node-id=\"3\" stroke=\"black\" fill=\"#3d3df5\" stroke-width=\"0.1\"/>\n<circle r=\"0.75\" cx=\"0.9197324514389038\" cy=\"99.49832916259766\" data-type=\"element node\" data-element-id=\"4\" data-node-id=\"4\" stroke=\"black\" fill=\"#3df53d\" stroke-width=\"0.1\"/>\n<circle r=\"0.75\" cx=\"99.74916076660156\" cy=\"98.82942962646484\" data-type=\"element node\" data-element-id=\"5\" data-node-id=\"5\" stroke=\"black\" fill=\"#3df53d\" stroke-width=\"0.1\"/>",
          "sublabels": [
              { "id": 0, "name": "center", "type": "points" },
              { "id": 1, "name": "top_left", "type": "points" },
              { "id": 2, "name": "top_right", "type": "points" },
              { "id": 3, "name": "bottom_left", "type": "points" },
              { "id": 4, "name": "bottom_right", "type": "points" }
          ]
        }
      ]

spec:
  description: Weed laser point estimation
  runtime: 'python:3.10'
  handler: main:handler
  eventTimeout: 30s

  build:
    image: cvat.pth.ultralytics.yolov8pose_weeds
    baseImage: python:3.10

    directives:
      preCopy:
        - kind: RUN
          value: apt update && apt install -y git libgl1 --no-install-recommends && rm -rf /var/lib/apt/lists/*
        - kind: WORKDIR
          value: /opt/nuclio
        - kind: RUN
          value: pip uninstall numpy && pip install "numpy<1.26.0"
        - kind: RUN
          value: pip install torch==2.0.0+cpu torchvision==0.15.1+cpu --extra-index-url https://download.pytorch.org/whl/cpu
        - kind: RUN
          value: pip install ultralytics opencv-python-headless==4.8.0.74 opencv-contrib-python==4.8.0.74 opencv-contrib-python-headless==4.8.0.74 pillow
        - kind: RUN
          value: pip install debugpy
  triggers:
    myHttpTrigger:
      maxWorkers: 2
      kind: 'http'
      workerAvailabilityTimeoutMilliseconds: 10000
      attributes:
        maxRequestBodySize: 33554432 # 32MB

  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
      mountMode: volume
